<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gracy Boys - Quotation Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card header" style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:18px">GRACY BOY'S — Quotation Editor</h2>
      <div class="controls">
        <a href="/dashboard.html" class="btn secondary" style="text-decoration:none">Dashboard</a>
        <button id="downloadPdf" class="btn">Download PDF</button>
        <button id="saveBtn" class="btn">Save</button>
      </div>
    </div>

    <div id="printArea" class="card print-area">
      <!-- letterpad image (add public/letterpad.png in repo) -->
      <img id="letterpad" src="letterpad.png" alt="Letterpad" class="letterpad" />

      <div class="title">QUOTATION ESTIMATE</div>

      <div class="meta-row">
        <div class="meta-left">
          <div class="label">Client Name:</div>
          <div class="value"><input id="clientName" placeholder="Client name / company" style="font-weight:600;border:0;background:transparent;width:100%"/></div>
          <div style="height:8px"></div>
          <div class="label">Event Title:</div>
          <div class="value"><input id="eventTitle" placeholder="Event title" style="border:0;background:transparent;width:100%"/></div>
        </div>
        <div class="meta-right" style="text-align:right">
          <div class="label">Date:</div>
          <div class="value" id="quoteDate"></div>
        </div>
      </div>

      <table class="table" id="itemsTable">
        <thead>
          <tr>
            <th style="width:55%">Requirements</th>
            <th style="width:20%">Amount (₹)</th>
            <th style="width:20%">Remark</th>
            <th style="width:5%"></th>
          </tr>
        </thead>
        <tbody id="itemsBody">
        </tbody>
      </table>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <button id="addRow" class="btn ghost small">+ Add row</button>
        <div class="total-wrap">
          <div class="total-label">Total Estimate</div>
          <div class="total-amount">₹ <span id="totalAmount">0.00</span></div>
        </div>
      </div>

      <div class="notes">
        <label style="font-weight:700">Notes / Terms:</label>
        <textarea id="notes" rows="3" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee"></textarea>
      </div>

      <div class="footer">
        <div class="left">
          MASTER: ARUL DOSS D<br/>
          PH: +91 8838414818<br/>
          +91 7358286678
        </div>
        <div class="right">
          For CHENNAI GRACY BOY'S<br/>
          <div style="margin-top:18px;font-family: 'Brush Script MT', cursive;font-size:18px;color:#2b2b2b">D. Arul Doss</div>
          <div style="border-top:1px solid #ddd;margin-top:6px;padding-top:6px;color:var(--muted);font-size:12px">Authorised Signature</div>
        </div>
      </div>
    </div>
  </div>

<script>
const itemsBody = document.getElementById('itemsBody');
const addRowBtn = document.getElementById('addRow');
const totalAmountEl = document.getElementById('totalAmount');
const saveBtn = document.getElementById('saveBtn');
const downloadPdfBtn = document.getElementById('downloadPdf');
const clientNameInput = document.getElementById('clientName');
const notesInput = document.getElementById('notes');
const eventTitleInput = document.getElementById('eventTitle');
const quoteDateEl = document.getElementById('quoteDate');

let currentId = null;

function formatAmount(n){
  return Number(n || 0).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function createRow(data = {}) {
  const tr = document.createElement('tr');

  const reqTd = document.createElement('td');
  const reqInput = document.createElement('input');
  reqInput.type = 'text';
  reqInput.value = data.requirement || '';
  reqTd.appendChild(reqInput);

  const amtTd = document.createElement('td');
  const amtInput = document.createElement('input');
  amtInput.type = 'number';
  amtInput.step = '0.01';
  amtInput.min = '0';
  amtInput.value = data.amount != null ? data.amount : '';
  amtInput.addEventListener('input', recalcTotal);
  amtTd.appendChild(amtInput);

  const remarkTd = document.createElement('td');
  const remarkInput = document.createElement('input');
  remarkInput.type = 'text';
  remarkInput.value = data.remark || '';
  remarkTd.appendChild(remarkInput);

  const actionsTd = document.createElement('td');
  const delBtn = document.createElement('button');
  delBtn.textContent = '✕';
  delBtn.className = 'btn ghost small';
  delBtn.style.padding = '6px 8px';
  delBtn.addEventListener('click', () => {
    tr.remove();
    recalcTotal();
  });
  actionsTd.appendChild(delBtn);

  tr.appendChild(reqTd);
  tr.appendChild(amtTd);
  tr.appendChild(remarkTd);
  tr.appendChild(actionsTd);

  itemsBody.appendChild(tr);
  recalcTotal();
}

function recalcTotal(){
  let sum = 0;
  const rows = itemsBody.querySelectorAll('tr');
  rows.forEach(r => {
    const amtInput = r.querySelector('td:nth-child(2) input');
    const val = parseFloat(amtInput.value || 0);
    if (!isNaN(val)) sum += val;
  });
  totalAmountEl.textContent = formatAmount(sum);
}

addRowBtn.addEventListener('click', () => createRow());

saveBtn.addEventListener('click', async () => {
  const payload = gatherQuotation();
  try {
    if (currentId) {
      const res = await fetch('/api/quotations/' + currentId, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      alert('Quotation updated');
      currentId = data.id;
      window.history.replaceState({}, '', '?id=' + currentId);
    } else {
      const res = await fetch('/api/quotations', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      alert('Quotation saved');
      currentId = data.id;
      window.history.replaceState({}, '', '?id=' + currentId);
    }
  } catch (err) {
    alert('Save failed: ' + err.message);
  }
});

function gatherQuotation(){
  const rows = [];
  itemsBody.querySelectorAll('tr').forEach(r => {
    const req = r.querySelector('td:nth-child(1) input').value;
    const amt = parseFloat(r.querySelector('td:nth-child(2) input').value || 0) || 0;
    const remark = r.querySelector('td:nth-child(3) input').value;
    if (req || amt || remark) {
      rows.push({requirement: req, amount: amt, remark});
    }
  });
  return {
    clientName: clientNameInput.value,
    eventTitle: eventTitleInput.value,
    date: new Date().toISOString(),
    items: rows,
    total: parseFloat(totalAmountEl.textContent.replace(/,/g,'')) || 0,
    notes: notesInput.value
  };
}

// PDF download
downloadPdfBtn.addEventListener('click', async () => {
  recalcTotal();
  const opt = {
    margin:       [10, 10, 10, 10],
    filename:     (clientNameInput.value ? clientNameInput.value.replace(/\s+/g,'_') + '_quotation.pdf' : 'quotation.pdf'),
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  const element = document.getElementById('printArea');
  html2pdf().set(opt).from(element).save();
});

// Load existing if id present in query param
async function loadIfId() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if (!id) {
    // add 2 blank rows by default
    createRow();
    createRow();
    quoteDateEl.textContent = new Date().toLocaleDateString();
    return;
  }
  try {
    const res = await fetch('/api/quotations/' + id);
    if (!res.ok) throw new Error('Not found');
    const q = await res.json();
    currentId = q.id;
    clientNameInput.value = q.clientName || '';
    eventTitleInput.value = q.eventTitle || '';
    notesInput.value = q.notes || '';
    quoteDateEl.textContent = q.date ? new Date(q.date).toLocaleDateString() : new Date().toLocaleDateString();
    itemsBody.innerHTML = '';
    (q.items || []).forEach(it => createRow(it));
    recalcTotal();
  } catch (err) {
    alert('Could not load quotation: ' + err.message);
  }
}

loadIfId();
</script>
</body>
</html>